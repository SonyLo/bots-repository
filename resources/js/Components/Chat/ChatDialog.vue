<template>


                <div class="row d-flex justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-6">

                        <div class="card" id="chat2">
                            <div class="card-header d-flex justify-content-between align-items-center p-3">
                                <h5 class="mb-0">Chat</h5>
                                <button type="button" class="btn btn-primary btn-sm" data-mdb-ripple-color="dark">Let's Chat App</button>
                            </div>
                            <div class="card-body perfect-scrollbar ps ps--active-y" data-mdb-perfect-scrollbar="true" style="position: relative; height: 400px">

                                <div class="d-flex flex-row justify-content-start">
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                                    <div>
                                        <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">Hi</p>
                                        <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">How are you ...???</p>
                                        <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">What are you doing
                                            tomorrow? Can we come up a bar?</p>
                                        <p class="small ms-3 mb-3 rounded-3 text-muted">23:58</p>
                                    </div>
                                </div>

                                <div class="divider d-flex align-items-center mb-4">
                                    <p class="text-center mx-3 mb-0" style="color: #a2aab7;">Today</p>
                                </div>

                                <div class="d-flex flex-row justify-content-end mb-4 pt-1">
                                    <div>
                                        <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Hiii, I'm good.</p>
                                        <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">How are you doing?</p>
                                        <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Long time no see! Tomorrow office. will
                                            be free on sunday.</p>
                                        <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:06</p>
                                    </div>
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                                </div>

                                <div class="d-flex flex-row justify-content-start mb-4">
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                                    <div>
                                        <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">Okay</p>
                                        <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">We will go on Sunday?</p>
                                        <p class="small ms-3 mb-3 rounded-3 text-muted">00:07</p>
                                    </div>
                                </div>

                                <div class="d-flex flex-row justify-content-end mb-4">
                                    <div>
                                        <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">That's awesome!</p>
                                        <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">I will meet you Sandon Square sharp at
                                            10 AM</p>
                                        <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Is that okay?</p>
                                        <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:09</p>
                                    </div>
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                                </div>

                                <div class="d-flex flex-row justify-content-start mb-4">
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                                    <div>
                                        <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">Okay i will meet you on
                                            Sandon Square</p>
                                        <p class="small ms-3 mb-3 rounded-3 text-muted">00:11</p>
                                    </div>
                                </div>

                                <div class="d-flex flex-row justify-content-end mb-4">
                                    <div>
                                        <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Do you have pictures of Matley
                                            Marriage?</p>
                                        <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:11</p>
                                    </div>
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                                </div>

                                <div class="d-flex flex-row justify-content-start mb-4">
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                                    <div>
                                        <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">Sorry I don't have. i
                                            changed my phone.</p>
                                        <p class="small ms-3 mb-3 rounded-3 text-muted">00:13</p>
                                    </div>
                                </div>

                                <div class="d-flex flex-row justify-content-end">
                                    <div>
                                        <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">Okay then see you on sunday!!</p>
                                        <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:15</p>
                                    </div>
                                    <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp" alt="avatar 1" style="width: 45px; height: 100%;">
                                </div>

                                <div class="ps__rail-x" style="left: 0px; bottom: -456px;"><div class="ps__thumb-x" tabindex="0" style="left: 0px; width: 0px;"></div></div><div class="ps__rail-y" style="top: 456px; height: 400px; right: 0px;"><div class="ps__thumb-y" tabindex="0" style="top: 148px; height: 129px;"></div></div></div>
                            <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
                                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp" alt="avatar 3" style="width: 40px; height: 100%;">
                                <input type="text" class="form-control form-control-lg" id="exampleFormControlInput1" placeholder="Type message">
                                <a class="ms-1 text-muted" href="#!"><i class="fas fa-paperclip"></i></a>
                                <a class="ms-3 text-muted" href="#!"><i class="fas fa-smile"></i></a>
                                <a class="ms-3" href="#!"><i class="fas fa-paper-plane"></i></a>
                            </div>
                        </div>

                    </div>
                </div>




    <div class="chat-window d-flex justify-content-between align-items-center flex-column">
        <perfect-scrollbar
            v-if="canEnter"
            class="ps-container w-100">
            <div class="message-card"
                 v-for="message in messages"
                 v-bind:class="{'incoming':message.direction === 'incoming', 'outgoing':message.direction === 'outgoing' }"
            >
                <div class="message-card-body">
                    <p v-html="message.text" v-if="message.text"></p>
                    <p v-html="message.caption" v-if="message.caption"></p>
                    <p v-if="message.created_at">{{ message.created_at }}</p>
                    <img v-lazy="message.photo" v-if="message.photo" class="w-100 mb-1 mt-1" alt="">
                    <div class="inline-keyboard w-100 " v-if="message.keyboard">

                        <div v-for="row in message.keyboard" class="d-flex justify-content-between flex-wrap">

                            <div class="d-flex justify-content-between w-100">
                                <div class="chat-inline-btn w-100" v-for="col in row">
                                    <button
                                        v-if="col.callback_data"
                                        @click="send(col.callback_data || col.text, 1)"
                                        class="btn btn-outline-light w-100">{{ col.text || col || '-' }}
                                    </button>

                                    <a
                                        class="btn btn-outline-light w-100"
                                        v-if="col.web_app"
                                        :href="'https://t.me/'+domain"
                                        target="_blank">Только в Telegram</a>


                                    <a
                                        class="btn btn-outline-light w-100"
                                        v-if="col.url"
                                        :href="col.url" target="_blank">{{ col.text || col || '-' }}</a>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>


            </div>
        </perfect-scrollbar>
        <div
            v-if="canEnter"
            class="footer">
            <div class="menu">
                <div class="dropdown dropup w-100 ">
                    <button class="chat-menu-btn w-100"
                            type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa-solid fa-ellipsis"></i>
                    </button>
                    <div class="dropdown-menu w-100 chat-custom-dropdown-menu">
                        <button
                            @click="send('/start')"
                            v-if="buttons.length===0"
                            class="btn btn-outline-light w-100 text-center">Начать
                        </button>

                        <perfect-scrollbar
                            v-if="buttons.length>0"
                            class="ps-keyboard-container buttons ">
                            <div v-for="row in buttons" class="d-flex justify-content-between flex-wrap">

                                <div class="d-flex justify-content-between w-100">
                                    <div class="chat-reply-btn w-100" v-for="col in row">
                                        <button
                                            @click="send( col.text || col)"
                                            class="btn btn-outline-light w-100">{{ col.text || col || '-' }}
                                        </button>
                                    </div>

                                </div>

                            </div>
                        </perfect-scrollbar>
                    </div>
                </div>
            </div>
            <div class="message">
                <input type="text"
                       :disabled="!loaded"
                       class="form-control w-100"
                       placeholder="text"
                       @keydown.enter="send(null)"
                       v-model="dataForm.message">
            </div>

        </div>
        <div class=" w-100" v-if="!canEnter">
            <form v-on:submit.prevent="login" class="p-2">
                <div class="form-floating mb-3">
                    <input type="text"
                           v-model="dataForm.user.first_name"
                           class="form-control" id="floatingInput" placeholder="name@example.com" required>
                    <label for="floatingInput">Ваше имя</label>
                </div>

                <div class="form-floating mb-3">
                    <input type="text"
                           v-model="dataForm.user.last_name"
                           class="form-control" id="floatingInput" placeholder="name@example.com" required>
                    <label for="floatingInput">Ваша фамилия</label>
                </div>

                <div class="form-floating mb-3">
                    <input type="text"
                           v-mask="'+7(###)###-##-##'"
                           v-model="dataForm.user.username"
                           class="form-control" id="floatingInput" placeholder="name@example.com" required>
                    <label for="floatingInput">Ваш номер телефона</label>
                </div>

                <button class="btn btn-outline-primary p-3 w-100">Войти</button>
            </form>

        </div>
    </div>


</template>

<script>

import {v4 as uuidv4} from "uuid";

export default {
    props: ["domain"],
    watch: {
        messages: function (newVal) {
            this.$nextTick(function () {
                var container = this.$el.querySelector("#scroll-area");
                container.scrollTop = container.scrollHeight + 120;
            });
        },
    },

    data() {
        return {
            loaded: true,
            canEnter: false,
            messages: [],
            buttons: [],
            dataForm: {
                message: null,
                query: null,
                user: {
                    id: null,
                    first_name: null,
                    last_name: null,
                    username: null,
                }
            }
        }
    },
    methods: {
        login() {
            this.canEnter = true
            this.dataForm.user.id = uuidv4();
            this.send('/start')
        },
        send(action = null, type = 0) {

            this.loaded = false
            console.log(action)

            let text = action || this.dataForm.message

            if (action) {
                this.dataForm.message = null
                this.dataForm.query = action
            }


            if (type === 0)
                this.messages.push({
                    text: text, direction: 'outgoing', created_at: (() => {
                        let today = new Date();
                        let dd = String(today.getDate()).padStart(2, '0');
                        let mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
                        let yyyy = today.getFullYear();
                        let min = today.getMinutes()
                        let hour = today.getHours()
                        let sec = today.getSeconds()
                        return yyyy + "-" + mm + "-" + dd + " " + hour + ":" + min + ":" + sec
                    })()
                });


            axios.post('/web/' + this.domain, this.dataForm)
                .then(resp => {
                    this.dataForm.message = null
                    this.dataForm.query = null

                    let data = resp.data;

                    data.forEach(item => {

                        let replyKeyboard = null;
                        if (item.reply_markup) {
                            let tmp = JSON.parse(item.reply_markup)

                            if (tmp.keyboard) {
                                this.buttons = tmp.keyboard;
                                this.is_keyboard = true;
                            }

                            replyKeyboard = tmp.inline_keyboard || null;
                        }


                        this.messages.push({
                            text: item.text || null,
                            direction: 'incoming',
                            keyboard: replyKeyboard,
                            photo: item.photo || null,
                            created_at: item.created_at || null
                        });

                        this.$nextTick(() => {
                            this.loaded = true
                        })
                    }).catch(() => {
                        this.$nextTick(() => {
                            this.loaded = true
                        })
                    })
                })
        },
    }
}
</script>

<style lang="scss">
#chat2 .form-control {
    border-color: transparent;
}

#chat2 .form-control:focus {
    border-color: transparent;
    box-shadow: inset 0px 0px 0px 1px transparent;
}

.divider:after,
.divider:before {
    content: "";
    flex: 1;
    height: 1px;
    background: #eee;
}
</style>
